# Lab 02: Malware Sample Clustering

Use unsupervised learning to cluster malware samples by behavior and characteristics.

---

## ðŸŽ¯ Learning Objectives

By completing this lab, you will:

1. Extract features from malware samples (static analysis)
2. Apply dimensionality reduction techniques
3. Use clustering algorithms (K-Means, DBSCAN)
4. Visualize malware families
5. Identify new malware variants

---

## â±ï¸ Estimated Time

60-75 minutes

---

## ðŸ“‹ Prerequisites

- Completed Lab 01
- Understanding of clustering concepts
- Python environment with ML libraries

### Required Libraries

```bash
pip install scikit-learn pandas numpy matplotlib seaborn
pip install pefile yara-python  # For PE analysis
```

---

## ðŸ“– Background

### Why Cluster Malware?

- **Family Identification**: Group samples by malware family
- **Variant Detection**: Find new variants of known malware
- **Threat Attribution**: Link samples to threat actors
- **Prioritization**: Focus analysis on unique samples

### Feature Extraction Approaches

| Feature Type | Examples | Use Case |
|--------------|----------|----------|
| Static | Import hash, section names, strings | Quick triage |
| Behavioral | API calls, network activity, file ops | Dynamic analysis |
| Structural | PE headers, entropy, size | Packer detection |

---

## ðŸ”¬ Lab Tasks

### Task 1: Load Sample Data (10 min)

Load and explore the malware feature dataset:

```python
def load_malware_data(filepath: str) -> pd.DataFrame:
    """
    Load pre-extracted malware features.
    
    Features include:
    - file_size: Size in bytes
    - entropy: Shannon entropy
    - num_imports: Number of imported functions
    - num_sections: Number of PE sections
    - has_debug: Debug info present
    - has_signature: Digital signature present
    - imphash: Import hash (categorical)
    - api_categories: Encoded API category vector
    
    TODO:
    1. Load CSV file
    2. Handle missing values
    3. Print dataset statistics
    """
    pass
```

### Task 2: Feature Engineering (15 min)

Transform features for clustering:

```python
def engineer_features(df: pd.DataFrame) -> np.ndarray:
    """
    Prepare features for clustering.
    
    TODO:
    1. Select numeric features
    2. Handle categorical features (one-hot encoding)
    3. Normalize/standardize features
    4. Return feature matrix
    
    Consider:
    - Log transform for skewed features (file_size)
    - Standard scaling for clustering
    - Handle outliers
    """
    pass
```

### Task 3: Dimensionality Reduction (15 min)

Reduce dimensions for visualization:

```python
def reduce_dimensions(X: np.ndarray, method: str = 'pca') -> np.ndarray:
    """
    Reduce feature dimensions for visualization and clustering.
    
    Args:
        X: Feature matrix
        method: 'pca', 'tsne', or 'umap'
        
    Returns:
        2D representation
        
    TODO:
    1. Apply PCA for initial reduction
    2. Apply t-SNE or UMAP for visualization
    3. Return 2D coordinates
    """
    pass
```

### Task 4: Clustering (15 min)

Apply clustering algorithms:

```python
def cluster_samples(X: np.ndarray, method: str = 'kmeans') -> np.ndarray:
    """
    Cluster malware samples.
    
    Args:
        X: Feature matrix (or reduced features)
        method: 'kmeans', 'dbscan', or 'hierarchical'
        
    Returns:
        Cluster labels
        
    TODO:
    1. Determine optimal number of clusters (elbow method)
    2. Apply selected clustering algorithm
    3. Evaluate clustering quality (silhouette score)
    4. Return cluster labels
    """
    pass
```

### Task 5: Visualization (10 min)

Create visualizations:

```python
def visualize_clusters(X_2d: np.ndarray, labels: np.ndarray, family_labels: np.ndarray = None):
    """
    Visualize clustering results.
    
    TODO:
    1. Create scatter plot with cluster colors
    2. If family_labels provided, create comparison plot
    3. Add legend and labels
    4. Save high-quality figure
    """
    pass
```

### Task 6: Analysis (10 min)

Analyze clustering results:

```python
def analyze_clusters(df: pd.DataFrame, labels: np.ndarray) -> dict:
    """
    Analyze characteristics of each cluster.
    
    Returns:
        Dict with cluster statistics:
        - size: Number of samples
        - avg_entropy: Average entropy
        - common_imports: Most common import functions
        - suspected_family: Likely malware family
        
    TODO:
    1. Group samples by cluster
    2. Calculate statistics per cluster
    3. Identify distinguishing features
    4. Suggest family names
    """
    pass
```

---

## ðŸ“ Files

```
lab02-malware-clustering/
â”œâ”€â”€ README.md
â”œâ”€â”€ starter/
â”‚   â””â”€â”€ main.py
â”œâ”€â”€ solution/
â”‚   â””â”€â”€ main.py
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ malware_features.csv    # Pre-extracted features
â”‚   â””â”€â”€ sample_info.csv         # Sample metadata
â””â”€â”€ output/
    â””â”€â”€ cluster_visualization.png
```

---

## ðŸ“Š Sample Dataset

```csv
sha256,file_size,entropy,num_imports,num_sections,has_debug,imphash,family
abc123...,245760,7.2,45,5,0,d4e5f6...,emotet
def456...,102400,6.8,32,4,0,a1b2c3...,trickbot
...
```

---

## âœ… Success Criteria

- [ ] Features normalized correctly
- [ ] Dimensionality reduction produces meaningful 2D plot
- [ ] Clustering finds 3-5 distinct groups
- [ ] Silhouette score > 0.3
- [ ] Visualization clearly shows cluster separation
- [ ] Analysis identifies likely malware families

---

## ðŸŽ¯ Expected Output

```
Clustering Results:
==================
Method: K-Means (k=4)
Silhouette Score: 0.42

Cluster 0 (n=156):
  - Avg entropy: 7.4
  - Avg size: 230KB
  - Common imports: VirtualAlloc, CreateRemoteThread
  - Suspected family: Cobalt Strike

Cluster 1 (n=89):
  - Avg entropy: 6.2
  - Avg size: 95KB
  - Common imports: InternetOpenUrl, HttpSendRequest
  - Suspected family: Banking Trojan

...
```

---

## ðŸš€ Bonus Challenges

1. **YARA Generation**: Create YARA rules for each cluster
2. **Dynamic Features**: Add behavioral features from sandbox reports
3. **Online Clustering**: Handle streaming new samples
4. **Outlier Detection**: Identify unique/novel samples
5. **Attribution**: Link clusters to known threat actors

---

## ðŸ’¡ Hints

<details>
<summary>Hint: Optimal K Selection</summary>

```python
from sklearn.metrics import silhouette_score

scores = []
for k in range(2, 10):
    kmeans = KMeans(n_clusters=k, random_state=42)
    labels = kmeans.fit_predict(X)
    scores.append(silhouette_score(X, labels))

optimal_k = range(2, 10)[np.argmax(scores)]
```
</details>

<details>
<summary>Hint: t-SNE Parameters</summary>

```python
from sklearn.manifold import TSNE

# Good starting parameters for malware data
tsne = TSNE(
    n_components=2,
    perplexity=30,
    learning_rate=200,
    n_iter=1000,
    random_state=42
)
X_2d = tsne.fit_transform(X)
```
</details>

---

## ðŸ“š Resources

- [Scikit-learn Clustering](https://scikit-learn.org/stable/modules/clustering.html)
- [t-SNE Explained](https://distill.pub/2016/misread-tsne/)
- [Malware Feature Engineering](https://www.malwaretech.com/)
- [PE File Format](https://docs.microsoft.com/en-us/windows/win32/debug/pe-format)

---

**Next Lab**: [Lab 03 - Anomaly Detection](../lab03-anomaly-detection/)

