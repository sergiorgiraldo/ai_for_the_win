#!/usr/bin/env python3
"""
Malware Analysis Assistant - Main Entry Point

AI-powered malware analysis with LLM explanations and YARA generation.
"""

import argparse
from pathlib import Path
from dotenv import load_dotenv
from rich.console import Console
from rich.panel import Panel
from rich.table import Table

load_dotenv()
console = Console()


def analyze_sample(filepath: str):
    """Analyze a malware sample."""
    path = Path(filepath)

    if not path.exists():
        console.print(f"[red]Error: File not found: {filepath}[/red]")
        return

    console.print(f"\n[yellow]Analyzing: {path.name}[/yellow]")
    console.print(f"Size: {path.stat().st_size:,} bytes\n")

    # TODO: Implement static analysis
    # from analyzer.static import StaticAnalyzer
    # analyzer = StaticAnalyzer()
    # results = analyzer.analyze(filepath)

    console.print("[yellow]Analysis stages:[/yellow]")
    console.print("  1. PE Header Parsing - TODO")
    console.print("  2. String Extraction - TODO")
    console.print("  3. Import Analysis - TODO")
    console.print("  4. Entropy Analysis - TODO")
    console.print("  5. LLM Explanation - TODO")
    console.print("  6. YARA Generation - TODO")

    console.print("\n[green]Complete the TODOs to enable analysis![/green]")


def interactive_mode():
    """Run interactive analysis mode."""
    console.print("\n[yellow]Interactive Mode[/yellow]")
    console.print("Commands: analyze <file>, explain, yara, report, quit\n")

    while True:
        try:
            cmd = console.input("[bold green]>[/bold green] ").strip()

            if cmd.lower() in ['quit', 'exit', 'q']:
                break

            if cmd.startswith("analyze "):
                filepath = cmd.split(" ", 1)[1]
                analyze_sample(filepath)
            else:
                console.print("[yellow]Unknown command. Try: analyze <file>[/yellow]")

        except KeyboardInterrupt:
            break

    console.print("\n[yellow]Goodbye![/yellow]")


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(description="Malware Analysis Assistant")
    parser.add_argument("--file", "-f", type=str, help="File to analyze")
    parser.add_argument("--interactive", "-i", action="store_true", help="Interactive mode")
    args = parser.parse_args()

    console.print(Panel.fit(
        "[bold magenta]Malware Analysis Assistant[/bold magenta]\n"
        "AI-powered static analysis and YARA generation",
        border_style="magenta"
    ))

    if args.file:
        analyze_sample(args.file)
    elif args.interactive:
        interactive_mode()
    else:
        console.print("\nUsage:")
        console.print("  python main.py --file sample.exe    # Analyze a file")
        console.print("  python main.py --interactive        # Interactive mode")


if __name__ == "__main__":
    main()
