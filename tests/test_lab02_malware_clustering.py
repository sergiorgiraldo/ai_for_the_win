#!/usr/bin/env python3
"""Tests for Lab 02: Malware Clustering."""

import pytest
import numpy as np
import sys
from pathlib import Path

# Add labs to path
sys.path.insert(0, str(Path(__file__).parent.parent / "labs" / "lab02-malware-clustering" / "solution"))

from main import (
    MalwareSample,
    extract_static_features,
    extract_behavioral_features,
    combine_features,
    cluster_with_kmeans,
    cluster_with_dbscan,
    cluster_with_hierarchical,
    evaluate_clustering,
    analyze_clusters
)


@pytest.fixture
def sample_malware_samples():
    """Create sample malware data for testing."""
    return [
        MalwareSample(
            sha256="abc123" * 10 + "abcd",
            file_size=102400,
            imports=["kernel32.dll", "user32.dll"],
            sections=[".text", ".data", ".rsrc"],
            strings=["http://malware.com", "password", "admin"],
            api_calls=["CreateFile", "WriteFile", "RegSetValue"],
            network_iocs=["192.168.1.100", "malware.com"],
            file_operations=["C:\\temp\\payload.exe"],
            registry_operations=["HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"],
            family="trojan"
        ),
        MalwareSample(
            sha256="def456" * 10 + "defg",
            file_size=204800,
            imports=["kernel32.dll", "advapi32.dll", "ws2_32.dll"],
            sections=[".text", ".data"],
            strings=["bitcoin", "wallet", "encrypt"],
            api_calls=["CryptEncrypt", "CryptDecrypt", "FindFirstFile"],
            network_iocs=["10.0.0.50"],
            file_operations=["C:\\Users\\*\\Documents\\*.doc"],
            registry_operations=[],
            family="ransomware"
        ),
        MalwareSample(
            sha256="ghi789" * 10 + "ghij",
            file_size=51200,
            imports=["kernel32.dll"],
            sections=[".text"],
            strings=["connect", "shell", "cmd"],
            api_calls=["CreateProcess", "socket", "connect"],
            network_iocs=["evil.com"],
            file_operations=[],
            registry_operations=[],
            family="backdoor"
        )
    ]


class TestFeatureExtraction:
    """Tests for feature extraction functions."""

    def test_extract_static_features(self, sample_malware_samples):
        """Test static feature extraction."""
        sample = sample_malware_samples[0]
        features = extract_static_features(sample)

        assert isinstance(features, np.ndarray)
        assert len(features) > 0
        # Check file size is included
        assert features[0] == sample.file_size

    def test_extract_behavioral_features(self, sample_malware_samples):
        """Test behavioral feature extraction."""
        sample = sample_malware_samples[0]
        features = extract_behavioral_features(sample)

        assert isinstance(features, np.ndarray)
        assert len(features) > 0

    def test_combine_features(self, sample_malware_samples):
        """Test feature combination."""
        static = np.array([1.0, 2.0, 3.0])
        behavioral = np.array([4.0, 5.0])

        combined = combine_features(static, behavioral)

        assert isinstance(combined, np.ndarray)
        assert len(combined) == len(static) + len(behavioral)


class TestClustering:
    """Tests for clustering algorithms."""

    @pytest.fixture
    def feature_matrix(self):
        """Create a sample feature matrix."""
        np.random.seed(42)
        # Create 3 distinct clusters
        cluster1 = np.random.randn(10, 5) + [0, 0, 0, 0, 0]
        cluster2 = np.random.randn(10, 5) + [5, 5, 5, 5, 5]
        cluster3 = np.random.randn(10, 5) + [10, 10, 10, 10, 10]
        return np.vstack([cluster1, cluster2, cluster3])

    def test_kmeans_clustering(self, feature_matrix):
        """Test K-means clustering."""
        labels, model = cluster_with_kmeans(feature_matrix, n_clusters=3)

        assert len(labels) == len(feature_matrix)
        assert len(set(labels)) == 3
        assert model is not None

    def test_dbscan_clustering(self, feature_matrix):
        """Test DBSCAN clustering."""
        labels = cluster_with_dbscan(feature_matrix, eps=2.0, min_samples=3)

        assert len(labels) == len(feature_matrix)
        # DBSCAN might find noise points (-1)
        assert len(set(labels)) >= 1

    def test_hierarchical_clustering(self, feature_matrix):
        """Test hierarchical clustering."""
        labels, linkage = cluster_with_hierarchical(feature_matrix, n_clusters=3)

        assert len(labels) == len(feature_matrix)
        assert len(set(labels)) == 3


class TestEvaluation:
    """Tests for clustering evaluation."""

    def test_evaluate_clustering_with_labels(self):
        """Test evaluation with true labels."""
        true_labels = np.array([0, 0, 0, 1, 1, 1, 2, 2, 2])
        pred_labels = np.array([1, 1, 1, 2, 2, 2, 0, 0, 0])  # Same structure, different numbers

        metrics = evaluate_clustering(true_labels, pred_labels, has_ground_truth=True)

        assert "ari" in metrics
        assert "nmi" in metrics
        # Perfect clustering should have ARI = 1.0
        assert metrics["ari"] == pytest.approx(1.0, abs=0.01)

    def test_evaluate_clustering_without_labels(self):
        """Test evaluation without true labels."""
        np.random.seed(42)
        X = np.random.randn(30, 5)
        pred_labels = np.array([0] * 10 + [1] * 10 + [2] * 10)

        metrics = evaluate_clustering(None, pred_labels, X=X, has_ground_truth=False)

        assert "silhouette" in metrics


class TestClusterAnalysis:
    """Tests for cluster analysis."""

    def test_analyze_clusters(self, sample_malware_samples):
        """Test cluster analysis."""
        labels = np.array([0, 0, 1])

        analysis = analyze_clusters(sample_malware_samples, labels)

        assert isinstance(analysis, dict)
        assert 0 in analysis or "0" in str(analysis)


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
